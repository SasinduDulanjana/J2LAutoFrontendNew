<div *ngIf="loading" class="loading-overlay">
  <span class="dialog-loader">
    <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
      <circle cx="24" cy="24" r="20" stroke="#e0e0e0" stroke-width="6" />
      <path d="M24 4a20 20 0 1 1-14.14 34.14" stroke="#1976d2" stroke-width="6" stroke-linecap="round">
        <animateTransform attributeName="transform" type="rotate" from="0 24 24" to="360 24 24" dur="1s" repeatCount="indefinite" />
      </path>
    </svg>
  </span>
  <span style="font-size:1.1rem;color:#1976d2;font-weight:500;">Creating sale & generating invoice...</span>
</div>
<div class="page-container">
  <!-- Common Box at the Top -->
  <div class="common-box">
    <div class="header-buttons">
      <button cButton color="success" variant="outline" size="lg" width="100px"
        (click)="navigateToDashboard()">Dashboard</button>
      <button cButton color="primary" variant="outline" size="lg" width="100px"
        (click)="navigateToOrders()">Sales</button>
      <!-- <button class="btn btn-primary">Order Type</button> -->
      <button cButton color="primary" variant="outline" size="lg" width="100px"
        (click)="openProductListPopup()">Products</button>


      <!-- Display selected customer name -->
      <c-col class="info-box">
        <label cLabel for="custId">Customer: </label>
        <label class="info-value">
          <!-- <div *ngIf="selectedCustomerName" (click)="openCustomerListPopup()">{{ selectedCustomerName }}</div> -->
          <span *ngIf="selectedCustomerName" class="clickable-customer" (click)="openCustomerListPopup()"
            style="cursor: pointer;">
            {{ selectedCustomerName }}
          </span>
        </label>
      </c-col>
      <!-- User ID -->
      <c-col class="info-box">
        <label cLabel for="userId">User: </label>
        <label class="info-value">
          <div>{{ loggedUserName }}</div>
        </label>
      </c-col>
      <!-- Order Date -->
      <c-col class="info-box">
        <label cLabel for="orderDate">Inv. Date: </label>
        <label class="info-value">{{ currentDate }}</label>
      </c-col>
      <!-- Invoice Number -->
      <c-col class="info-box">
        <label cLabel for="invoiceNumber">Inv. Number: </label>
        <label class="info-value">
          <div *ngIf="invoiceNumber">{{ invoiceNumber }}</div>
        </label>
      </c-col>
    </div>
  </div>


  <!-- Flex container for side-by-side boxes -->
  <div class="flex-boxes">
  <!-- Box 1(left) -->
  <div class="box box-left" style="position: relative;">
  <form (ngSubmit)="createSale()" #saleForm="ngForm" cForm class="row g-3">
        <c-col [xs]="12">
          <input id="searchProduct" type="text" [(ngModel)]="productSearchTerm" (input)="searchProduct()"
            (keypress)="handleKeypress($event)" name="searchProduct" class="form-control"
            placeholder="Search Product (SKU, BarCode)" />
          <div *ngIf="searchResults.length > 0" class="dropdown-list">
            <ul class="list-group">
              <li *ngFor="let product of searchResults" class="list-group-item list-group-item-action"
                (click)="selectProduct(product)">
                {{ product.productName }} - (SKU: {{ product.sku }}) - (Barcode: {{ product.barCode }})
              </li>
            </ul>
          </div>
        </c-col>
        <c-col [xs]="12">
          <div class="table-wrapper table-lg">
            <table class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Name</th>
                  <th>Batch</th>
                  <th>Qty</th>
                  <th>U. Price</th>
                  <th>Disc. %</th>
                  <th>Disc.</th>
                  <th>Total</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of saleItems; let i = index">
                  <td>{{ i + 1 }}</td>
                  <td>{{ item.productName }}</td>
                  <td>{{ item.batchNo }}</td>
                    <td style="text-align: center; vertical-align: middle;">
                      <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <input type="text" class="qty-input" min="1" [max]="getMaxQty(item.batchNo)" [(ngModel)]="item.remainingQty" name="qty_{{item.batchNo}}" [ngModelOptions]="{standalone: true}" [value]="item.remainingQty || 1" (ngModelChange)="onQtyChange(item)" (blur)="onQtyBlur(item)" />
                        <div *ngIf="qtyError[item.batchNo]" class="qty-error-message">
                          <svg style="vertical-align:middle;margin-right:4px;" width="16" height="16" fill="#d32f2f" viewBox="0 0 16 16"><path d="M8 1a7 7 0 1 1 0 14A7 7 0 0 1 8 1zm0 2a5 5 0 1 0 0 10A5 5 0 0 0 8 3zm-.75 3.75a.75.75 0 0 1 1.5 0v2.5a.75.75 0 0 1-1.5 0v-2.5zm.75 5a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5z"/></svg>
                          <span style="color:#d32f2f;font-size:0.97em;font-weight:500;">{{ qtyError[item.batchNo] }}</span>
                        </div>
                      </div>
                    </td>
                  <td>{{ item.retailPrice}}</td>
                  <td>
                    <label class="discount-label" (click)="openDiscountModal(item)" style="cursor: pointer;">
                      <span class="discount-value">{{ item.discountPercentage ?? 0 }}%</span>
                    </label>
                  </td>
                  <td>
                    <label class="discount-amount">
                      {{ ((item?.discountPercentage ?? 0) / 100 * (item?.retailPrice ?? 0) * (item?.remainingQty ?? 0))}}
                    </label>
                  </td>
                  <td>{{ ((item?.remainingQty ?? 0) * (item?.retailPrice ?? 0) - ((item?.discountPercentage ?? 0) / 100 * (item?.retailPrice ?? 0) * (item?.remainingQty ?? 0)))}}</td>
                  <td>
                    <button (click)="removeSaleItem(item)" class="btn-close-rounded">&times;</button>
                  </td>
                </tr>
                <tr *ngFor="let placeholder of placeholderRows">
                  <td colspan="10" class="empty-row"> </td>
                </tr>
              </tbody>
            </table>
          </div>
        </c-col>
        <c-col [xs]="4">
          <div class="d-grid gap-2">
            <button cButton color="success" size="lg" type="submit"
              [disabled]="!saleForm.form.valid || saleItems.length === 0 || loading" style="color: white; position:relative;">
              <ng-container *ngIf="!loading">Create Sale</ng-container>
              <ng-container *ngIf="loading">
                <span class="button-loader">
                  <svg width="22" height="22" viewBox="0 0 22 22" fill="none">
                    <circle cx="11" cy="11" r="9" stroke="#e0e0e0" stroke-width="4" />
                    <path d="M11 2a9 9 0 1 1-6.36 15.36" stroke="#1976d2" stroke-width="4" stroke-linecap="round">
                      <animateTransform attributeName="transform" type="rotate" from="0 11 11" to="360 11 11" dur="0.7s" repeatCount="indefinite" />
                    </path>
                  </svg>
                </span>
                <span style="margin-left:8px; color:#1976d2; font-weight:500; font-size:1rem;">Processing...</span>
              </ng-container>
            </button>
          </div>
        </c-col>
        <c-col [xs]="12" *ngIf="showBillButton">
          <div class="d-grid gap-2">
            <button cButton color="info" size="lg" (click)="openBillDialog()" style="color: white;">View/Print Bill</button>
          </div>
        </c-col>
        <c-col [xs]="4">
          <div class="d-grid gap-2">
            <button cButton color="secondary" size="lg" (click)="holdSale()" style="color: white;">Hold</button>
          </div>
        </c-col>
        <c-col [xs]="4">
          <div class="d-grid gap-2">
            <button cButton color="danger" size="lg" width="100px" (click)="clearForm()" style="color: white;">Reset</button>
          </div>
        </c-col>
      </form>
    </div>
    


    <!-- Box 2 (Right): Summary Totals -->
    <div class="box box-right" style="display: flex; flex-direction: column; height: 100%; justify-content: space-between;">
      <div class="footer-labels">
        <div class="footer-row">
          <strong>Subtotal:</strong>
          <span>{{ getSubtotal() | currency: 'LKR ' }}</span>
        </div>
        <div class="footer-row">
          <strong>Line Wise Discount Total:</strong>
          <span>{{ getTotalDiscount() | currency: 'LKR ' }}</span>
        </div>
        <div class="footer-row">
          <strong>Bill Wise Discount: (%)</strong>
          <span class="discount-label" (click)="openBillWiseDiscountModal()" style="cursor: pointer;">
            {{ billWiseDiscountPercentage }}%
          </span>
        </div>
        <div class="footer-row">
          <strong>Bill Wise Discount Total:</strong>
          <span>{{ getTotalBillWiseDiscount() | currency: 'LKR ' }}</span>
        </div>
        <div class="footer-row">
          <strong>Net Total:</strong>
          <span>{{ getTotal() | currency: 'LKR ' }}</span>
        </div>
        <div style="margin-top: 32px; display: flex; justify-content: flex-end; align-items: flex-end; min-height: 60px;">
          <img src="assets/img/logo.png" alt="Logo" style="height: 140px; width: 350px; opacity: 0.98;" />
        </div>
      </div>
    </div>

  </div>
</div>