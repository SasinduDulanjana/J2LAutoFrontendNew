<div *ngIf="loading" class="loading-overlay">
  <span class="dialog-loader">
    <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
      <circle cx="24" cy="24" r="20" stroke="#e0e0e0" stroke-width="6" />
      <path d="M24 4a20 20 0 1 1-14.14 34.14" stroke="#1976d2" stroke-width="6" stroke-linecap="round">
        <animateTransform attributeName="transform" type="rotate" from="0 24 24" to="360 24 24" dur="1s" repeatCount="indefinite" />
      </path>
    </svg>
  </span>
  <span style="font-size:1.1rem;color:#1976d2;font-weight:500;">Creating sale & generating invoice...</span>
</div>
<div class="page-container">
  <!-- Common Box at the Top -->
  <div class="common-box">
    <div class="header-buttons">
      <div class="header-nav" role="navigation" aria-label="Main actions">
        <button class="nav-btn nav-btn-ghost" aria-label="Dashboard" (click)="navigateToDashboard()">
          <svg class="nav-icon" viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 13h8V3H3v10zM13 21h8V11h-8v10zM3 21h8v-6H3v6zM13 3v6h8V3h-8z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span>Dashboard</span>
        </button>

        <button class="nav-btn nav-btn-ghost" aria-label="Sales" (click)="navigateToOrders()">
          <svg class="nav-icon" viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18M3 12h18M7 18h10" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span>Sales</span>
        </button>

        <button class="nav-btn nav-btn-ghost" aria-label="Products" (click)="openProductListPopup()">
          <svg class="nav-icon" viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span>Products</span>
        </button>

        <div class="nav-spacer"></div>
        <div class="nav-spacer"></div>
        <div class="nav-spacer"></div>
        <div class="nav-spacer"></div>
        <div class="nav-spacer"></div>
        <div class="nav-spacer"></div>

        <button class="nav-btn nav-btn-primary" aria-label="Add Product" (click)="openCreateProductPopup()">
          <svg class="nav-icon" viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span>Add Product</span>
        </button>

        <button class="nav-btn nav-btn-primary" aria-label="Create Purchase" (click)="openCreatePurchasePopup()">
          <svg class="nav-icon" viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 7h18M7 7v14h10V7" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span>Create Purchase</span>
        </button>
      </div>


      <!-- Display selected customer name -->
      <!-- <c-col class="info-box">
        <label cLabel for="custId">Customer: </label>
        <label class="info-value">
          <span *ngIf="selectedCustomerName" class="clickable-customer" (click)="openCustomerListPopup()"
            style="cursor: pointer;">
            {{ selectedCustomerName }}
          </span>
        </label>
      </c-col> -->
      <!-- User ID -->
      <!-- <c-col class="info-box">
        <label cLabel for="userId">User: </label>
        <label class="info-value">
          <div>{{ loggedUserName }}</div>
        </label>
      </c-col> -->
      <!-- Order Date -->
      <!-- <c-col class="info-box">
        <label cLabel for="orderDate">Inv. Date: </label>
        <label class="info-value">{{ currentDate }}</label>
      </c-col> -->
      <!-- Invoice Number -->
      <!-- <c-col class="info-box">
        <label cLabel for="invoiceNumber">Inv. Number: </label>
        <label class="info-value">
          <div *ngIf="invoiceNumber">{{ invoiceNumber }}</div>
        </label>
      </c-col> -->
    </div>
  </div>


  <!-- Flex container for side-by-side boxes -->
  <div class="flex-boxes">
  <!-- Box 1(left) -->
  <div class="box box-left" style="position: relative;">
  <form (ngSubmit)="createSale()" #saleForm="ngForm" cForm class="row g-3">
        <c-col [xs]="12">
          <div class="row mb-3">
            <div class="col-4 position-relative">
              <!-- <label for="customerSearch" class="form-label">Search Customer</label> -->
              <div class="d-flex align-items-center">
                <input id="customerSearch" type="text" class="form-control" [(ngModel)]="customerSearchTerm" (input)="searchCustomer()" name="customerSearch" placeholder="Search Customer" autocomplete="off" />
                <button cButton color="success" type="button" style="margin-left:8px;width:40px;min-width:40px;padding:0 4px;" (click)="openAddCustomerDialog()" title="Add Customer">
                  <svg cIcon name="cil-plus" style="width:20px;height:35px;"></svg>
                </button>
              </div>
              <div *ngIf="customerResults.length > 0" class="dropdown-list" style="position:absolute;width:100%;z-index:10;">
                <ul class="list-group">
                  <li *ngFor="let c of customerResults" class="list-group-item list-group-item-action" (click)="selectCustomer(c)">
                    <span>{{ c.name }}{{ c.phone ? (' - ' + c.phone) : '' }}</span>
                  </li>
                </ul>
              </div>
            </div>
            <div class="col-4 position-relative">
              <!-- <label for="vehicleSearch" class="form-label">Search Vehicle</label> -->
              <div class="d-flex align-items-center">
                <input id="vehicleSearch" type="text" class="form-control" [(ngModel)]="vehicleSearchTerm" (input)="searchVehicle()" name="vehicleSearch" placeholder="Search Vehicle" autocomplete="off" />
                <button cButton color="success" type="button" style="margin-left:8px;width:40px;min-width:40px;padding:0 4px;" (click)="openCreateVehiclePopup()" title="Add Vehicle">
                  <svg cIcon name="cil-plus" style="width:20px;height:35px;"></svg>
                </button>
              </div>
              <div *ngIf="vehicleResults.length > 0" class="dropdown-list" style="position:absolute;width:100%;z-index:10;">
                <ul class="list-group">
                  <li *ngFor="let v of vehicleResults" class="list-group-item list-group-item-action" (click)="selectVehicle(v)">
                    <span>{{ v.make }} {{ v.model }} {{ v.year }}</span>
                  </li>
                </ul>
              </div>
            </div>
            <div class="col-4">
              <!-- <label for="vehicleNumber" class="form-label">Vehicle Number</label> -->
              <input id="vehicleNumber" type="text" class="form-control" [(ngModel)]="vehicleNumber" name="vehicleNumber" placeholder="Enter Vehicle Number" />
            </div>
          </div>
          <input id="searchProduct" type="text" [(ngModel)]="productSearchTerm" (input)="searchProduct()"
            (keypress)="handleKeypress($event)" name="searchProduct" class="form-control"
            placeholder="Search Product" />
          <div *ngIf="searchResults.length > 0" class="dropdown-list">
            <ul class="list-group">
              <li *ngFor="let product of searchResults" class="list-group-item list-group-item-action"
                (click)="selectProduct(product)">
                <span *ngIf="product.vehicle"> {{ product.vehicle.make || '-' }} {{ product.vehicle.model || '-' }} {{ product.vehicle.year || '-' }} {{ product.productName }}</span>
              </li>
            </ul>
          </div>
        </c-col>
        <c-col [xs]="12">
          <div class="table-wrapper table-lg">
            <table class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Name</th>
                  <th>Batch</th>
                  <th>Qty</th>
                  <th>Unit Cost</th>
                  <th>U. Price</th>
                  <!-- <th>Disc. %</th>
                  <th>Disc.</th> -->
                  <th>Total</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of saleItems; let i = index">
                  <td>{{ i + 1 }}</td>
                  <!-- <td>{{ item.productName }}</td> -->
                   <td>{{ item.vehicle.make || '-' }} {{ item.vehicle.model || '-' }} {{ item.vehicle.year || '-' }} {{ item.productName }}</td>
                  <td>{{ item.batchNo }}</td>
                    <td style="text-align: center; vertical-align: middle;">
                      <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <input type="text" class="qty-input" min="1" [max]="getMaxQty(item.batchNo)" [(ngModel)]="item.remainingQty" name="qty_{{item.batchNo}}" [ngModelOptions]="{standalone: true}" [value]="item.remainingQty || 1" (ngModelChange)="onQtyChange(item)" (blur)="onQtyBlur(item)" />
                        <div *ngIf="qtyError[item.batchNo]" class="qty-error-message">
                          <svg style="vertical-align:middle;margin-right:4px;" width="16" height="16" fill="#d32f2f" viewBox="0 0 16 16"><path d="M8 1a7 7 0 1 1 0 14A7 7 0 0 1 8 1zm0 2a5 5 0 1 0 0 10A5 5 0 0 0 8 3zm-.75 3.75a.75.75 0 0 1 1.5 0v2.5a.75.75 0 0 1-1.5 0v-2.5zm.75 5a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5z"/></svg>
                          <span style="color:#d32f2f;font-size:0.97em;font-weight:500;">{{ qtyError[item.batchNo] }}</span>
                        </div>
                      </div>
                    </td>
                  <td style="text-align: center; vertical-align: middle;">
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                      <span>{{ item.unitCost }}</span>
                    </div>
                  </td>
                  <td style="text-align: center; vertical-align: middle;">
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                      <input type="number" class="qty-input" min="0" [(ngModel)]="item.retailPrice" name="retailPrice_{{item.batchNo}}" [ngModelOptions]="{standalone: true}" [value]="item.retailPrice || 0" style="width: 80px;" (ngModelChange)="onRetailPriceChange(item)" />
                    </div>
                  </td>
                  
                  <!-- <td>
                    <label class="discount-label" (click)="openDiscountModal(item)" style="cursor: pointer;">
                      <span class="discount-value">{{ item.discountPercentage ?? 0 }}%</span>
                    </label>
                  </td> -->
                  <!-- <td>
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                      <input type="number" class="qty-input" min="0" [(ngModel)]="item.discountAmount" name="discountAmount_{{item.batchNo}}" [ngModelOptions]="{standalone: true}" [value]="item.discountAmount === undefined || item.discountAmount === null ? 0 : item.discountAmount" style="width: 80px;" (ngModelChange)="onDiscountAmountChange(item)" />
                      <div *ngIf="item.discountAmount < 0" class="qty-error-message">
                        <svg style="vertical-align:middle;margin-right:4px;" width="16" height="16" fill="#d32f2f" viewBox="0 0 16 16"><path d="M8 1a7 7 0 1 1 0 14A7 7 0 0 1 8 1zm0 2a5 5 0 1 0 0 10A5 5 0 0 0 8 3zm-.75 3.75a.75.75 0 0 1 1.5 0v2.5a.75.75 0 0 1-1.5 0v-2.5zm.75 5a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5z"/></svg>
                        <span style="color:#d32f2f;font-size:0.97em;font-weight:500;">Discount cannot be negative</span>
                      </div>
                    </div>
                   
                  </td> -->
                  <td>{{ getNetTotal(item) }}</td>
                  <td>
                    <button (click)="removeSaleItem(item)" class="btn-close-rounded">&times;</button>
                  </td>
                </tr>
                <tr *ngFor="let placeholder of placeholderRows">
                  <td colspan="10" class="empty-row"> </td>
                </tr>
              </tbody>
            </table>
          </div>
        </c-col>
        <c-col [xs]="6">
          <div class="d-grid gap-2">
            <button cButton color="success" size="lg" type="submit"
              [disabled]="!saleForm.form.valid || saleItems.length === 0 || loading" style="color: white; position:relative;">
              <ng-container *ngIf="!loading">Create Sale</ng-container>
              <ng-container *ngIf="loading">
                <span class="button-loader">
                  <svg width="22" height="22" viewBox="0 0 22 22" fill="none">
                    <circle cx="11" cy="11" r="9" stroke="#e0e0e0" stroke-width="4" />
                    <path d="M11 2a9 9 0 1 1-6.36 15.36" stroke="#1976d2" stroke-width="4" stroke-linecap="round">
                      <animateTransform attributeName="transform" type="rotate" from="0 11 11" to="360 11 11" dur="0.7s" repeatCount="indefinite" />
                    </path>
                  </svg>
                </span>
                <span style="margin-left:8px; color:#1976d2; font-weight:500; font-size:1rem;">Processing...</span>
              </ng-container>
            </button>
          </div>
        </c-col>
        <c-col [xs]="12" *ngIf="showBillButton">
          <div class="d-grid gap-2">
            <button cButton color="info" size="lg" (click)="openBillDialog()" style="color: white;">View/Print Bill</button>
          </div>
        </c-col>
        <!-- <c-col [xs]="4">
          <div class="d-grid gap-2">
            <button cButton color="secondary" size="lg" (click)="holdSale()" style="color: white;">Hold</button>
          </div>
        </c-col> -->
        <c-col [xs]="6">
          <div class="d-grid gap-2">
            <button cButton color="danger" size="lg" width="100px" (click)="clearForm()" style="color: white;">Reset</button>
          </div>
        </c-col>
      </form>
    </div>
    


    <!-- Box 2 (Right): Summary Totals -->
    <div class="box box-right" style="display: flex; flex-direction: column; height: 100%; justify-content: space-between;">
      <div class="footer-labels">
        <div class="footer-row">
          <strong>Subtotal:</strong>
          <span>{{ getSubtotal() | currency: 'LKR ' }}</span>
        </div>
        <!-- <div class="footer-row">
          <strong>Line Wise Discount Total:</strong>
          <span>{{ getTotalDiscount() | currency: 'LKR ' }}</span>
        </div> -->
        <div class="footer-row">
          <strong>Bill Wise Discount: (%)</strong>
          <span class="discount-label" (click)="openBillWiseDiscountModal()" style="cursor: pointer;">
            {{ billWiseDiscountPercentage }}%
          </span>
        </div>
        <div class="footer-row">
          <strong>Bill Wise Discount Total:</strong>
          <span>{{ getTotalBillWiseDiscount() | currency: 'LKR ' }}</span>
        </div>
        <div class="footer-row">
          <strong>Net Total:</strong>
          <span>{{ getTotal() | currency: 'LKR ' }}</span>
        </div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div class="footer-row footer-red">
          <strong>Invoice Number:</strong>
          <span>{{ invoiceNumber || '-' }}</span>
        </div>

        <div class="footer-row footer-red">
          <strong>Invoice Date:</strong>
          <span>{{ currentDate || '-' }}</span>
        </div>

        <div class="footer-row footer-red">
          <strong>Logged User:</strong>
          <span>{{ loggedUserName || '-' }}</span>
        </div>
        <!-- <div style="margin-top: 18px; display: flex; justify-content: flex-end; align-items: flex-end; min-height: 60px;">
          <img src="assets/img/logo.png" alt="Logo" style="height: 80px; width: 250px; opacity: 0.98;" />
        </div> -->
      </div>
    </div>

  </div>
</div>