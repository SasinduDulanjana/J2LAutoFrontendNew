<div *ngIf="loading" class="loading-overlay">
  <div class="spinner"></div>
  <span>Loading Payment History...</span>
</div>
<div class="container py-4">
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0">Payment History</h4>
      <div class="sale-header-actions d-flex gap-2">
        <button class="custom-outline-btn export-btn" (click)="exportToPDF()">
          <mat-icon class="me-1">picture_as_pdf</mat-icon>
          <span>Export PDF</span>
        </button>
      </div>
    </div>
    <div class="card-body">
      <div *ngIf="sale && !loading" class="mt-4">
        <div class="modern-info-card mb-4 p-3 d-flex flex-wrap align-items-center justify-content-between shadow-sm">
          <div class="info-item d-flex align-items-center gap-2">
            <span class="info-label">Invoice No:</span>
            <span class="info-value fw-bold">{{ sale?.invoiceNumber }}</span>
          </div>
          <div class="info-item d-flex align-items-center gap-2">
            <span class="info-label">Customer:</span>
            <span class="info-value text-primary fw-bold">{{ sale?.customer?.name }}</span>
          </div>
          <div class="info-item d-flex align-items-center gap-2">
            <span class="info-label">Net Total:</span>
            <span class="info-value text-info fw-bold">{{ sale?.totalAmount }}</span>
          </div>
          <div class="info-item d-flex align-items-center gap-2">
            <span class="info-label">Paid Amount:</span>
            <span class="info-value text-success fw-bold">{{ sale?.paidAmount }}</span>
          </div>
          <div class="info-item d-flex align-items-center gap-2">
            <span class="info-label">Return Amount:</span>
            <span class="info-value text-warning fw-bold">{{ (sale?.returnAmount || 0) | number:'1.2-2' }}</span>
          </div>
          <div class="info-item d-flex align-items-center gap-2">
            <span class="info-label">Outstanding:</span>
            <span class="info-value text-danger fw-bold">{{ sale?.outstanding != null ? (sale.outstanding | number:'1.2-2') : ((sale?.totalAmount - sale?.paidAmount) | number:'1.2-2') }}</span>
          </div>
        </div>
        <div class="card shadow-sm modern-details-card">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">Payment Details</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Date & Time</th>
                    <th>Method</th>
                    <th>Cheque No</th>
                    <th>Bank Name</th>
                    <th>Cheque Date</th>
                    <th>Amount</th>
                    <th>Payment Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let payment of paymentHistory">
                    <td>{{ payment.date | date:'yyyy-MM-dd HH:mm:ss' }}</td>
                    <td>{{ payment.method }}</td>
                    <td>{{ payment.chequeNo ? payment.chequeNo : '-' }}</td>
                    <td>{{ payment.bankName ? payment.bankName : '-' }}</td>
                    <td>{{ payment.chequeDate ? payment.chequeDate : '-' }}</td>
                    <td>{{ payment.amount }}</td>
                    <td>
                      <span [ngClass]="{
                        'status-badge paid': payment.status === 'Paid',
                        'status-badge cleared': payment.status === 'Cleared',
                        'status-badge pending': payment.status === 'Pending',
                        'status-badge failed': payment.status === 'Failed',
                        'status-badge unknown': payment.status !== 'Paid' && payment.status !== 'Cleared' && payment.status !== 'Pending' && payment.status !== 'Failed'
                      }">
                        <svg *ngIf="payment.status === 'Paid' || payment.status === 'Cleared'"  class="badge-icon"></svg>
                        <svg *ngIf="payment.status === 'Pending'"  class="badge-icon"></svg>
                        <svg *ngIf="payment.status === 'Failed'"  class="badge-icon"></svg>
                        <svg *ngIf="payment.status !== 'Paid' && payment.status !== 'Cleared' && payment.status !== 'Pending' && payment.status !== 'Failed'" class="badge-icon"></svg>
                        {{ payment.status }}
                      </span>
                    </td>
                  </tr>
                  <tr *ngIf="paymentHistory.length === 0">
                    <td colspan="7" class="text-center text-muted">No payment history found.</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="d-flex justify-content-end mt-4">
              <button class="btn btn-success pay-balance-btn" style="min-width: 160px; height: 44px; font-size: 1.08rem; font-weight: 600;" (click)="payBalance()" [disabled]="!sale || (sale.outstanding != null ? sale.outstanding <= 0 : ((sale.totalAmount - sale.paidAmount) <= 0))">
                <svg cIcon name="cil-credit-card" class="me-2"></svg> Pay Balance
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
<!-- Removed extra closing divs to fix template error -->
  </div>
</div>
