<div *ngIf="loading" class="loading-overlay">
  <div class="spinner"></div>
  <span>Loading Cheque Details...</span>
</div>

<div class="container py-4">
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0">Cheque Management</h4>
      <div class="sale-header-actions d-flex gap-2">
        <button class="custom-outline-btn export-btn" (click)="exportToPDF()">
          <mat-icon class="me-1">picture_as_pdf</mat-icon>
          <span>Export PDF</span>
        </button>
      </div>
    </div>
    <div class="card-body">
      <div class="row mb-4 g-3">
        <div class="col-md-3">
          <div class="cheque-dashboard-card card border-0 shadow-sm text-center py-3 bg-gradient bg-white position-relative overflow-hidden">
            <div class="fs-6 mb-1 mt-2 text-dark">Total Pending Received Cheques</div>
            <div class="fw-bold fs-4 text-warning">LKR {{ getTotal('PENDING', 'Received') | number:'1.2-2' }}</div>
            <div class="text-muted small">to be cleared</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="cheque-dashboard-card card border-0 shadow-sm text-center py-3 bg-gradient bg-white position-relative overflow-hidden">
            <div class="fs-6 mb-1 mt-2 text-dark">Total Pending Issued Cheques</div>
            <div class="fw-bold fs-4 text-warning">LKR {{ getTotal('PENDING', 'Issued') | number:'1.2-2' }}</div>
            <div class="text-muted small">to be honored</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="cheque-dashboard-card card border-0 shadow-sm text-center py-3 bg-gradient bg-white position-relative overflow-hidden">
            <div class="fs-6 mb-1 mt-2 text-dark">Cleared Cheques This Month</div>
            <div class="fw-bold fs-4 text-success">LKR {{ getClearedThisMonth() | number:'1.2-2' }}</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="cheque-dashboard-card card border-0 shadow-sm text-center py-3 bg-gradient bg-white position-relative overflow-hidden">
            <div class="fs-6 mb-1 mt-2 text-dark">Bounced Cheques</div>
            <div class="fw-bold fs-4 text-danger">LKR {{ getTotal('BOUNCED') | number:'1.2-2' }}</div>
          </div>
        </div>
      </div>
      <div class="cheque-filters mb-3 p-2 bg-light rounded shadow-sm">
        <form class="row g-2 align-items-end">
          <div class="col-md-2">
            <label class="form-label mb-1">Issue Date From</label>
            <input type="date" class="form-control" [(ngModel)]="filter.fromDate" name="fromDate">
          </div>
          <div class="col-md-2">
            <label class="form-label mb-1">Issue Date To</label>
            <input type="date" class="form-control" [(ngModel)]="filter.toDate" name="toDate">
          </div>
          <div class="col-md-2">
            <label class="form-label mb-1">Status</label>
            <select class="form-select" [(ngModel)]="filter.status" name="status">
              <option value="">All</option>
              <option value="PENDING">Pending</option>
              <option value="CLEARED">Cleared</option>
              <option value="BOUNCED">Bounced</option>
              <option value="DEPOSITED">Deposited</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label mb-1">Type</label>
            <select class="form-select" [(ngModel)]="filter.type" name="type">
              <option value="">All</option>
              <option value="Received">Received</option>
              <option value="Issued">Issued</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label mb-1">Customer/Supplier</label>
            <select class="form-select" [(ngModel)]="filter.party" name="party">
              <option value="">All</option>
              <option *ngFor="let p of partyOptions" [value]="p">{{ p }}</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label mb-1">Search</label>
            <input type="text" class="form-control" [(ngModel)]="filter.search" name="search" placeholder="Cheque No, Bank">
          </div>
          <div class="col-md-1">
            <button type="button" class="btn btn-primary w-100" (click)="applyFilters()">Filter</button>
          </div>
          <div class="col-md-1">
            <button type="button" class="btn btn-outline-secondary w-100" (click)="clearFilters()">Clear</button>
          </div>
        </form>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Cheque No</th>
              <th>Bank Name</th>
              <th>Type</th>
              <th>Customer/Supplier</th>
              <th>Amount</th>
              <th>Issue Date</th>
              <th>Due Date</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let cheque of cheques">
              <td>{{ cheque.chequeNo }}</td>
              <td>{{ cheque.bankName }}</td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  <span [ngClass]="{
                    'text-success': cheque.type === 'RECEIVED',
                    'text-danger': cheque.type === 'ISSUED',
                  }" style="min-width:80px;">
                    {{ cheque.type }}
                  </span>
                </div>
              </td>
              <td>{{ cheque.party }}</td>
              <td>{{ cheque.amount | number:'1.2-2' }}</td>
              <td>{{ cheque.issueDate }}</td>
              <td>{{ cheque.dueDate }}</td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  <span [ngClass]="{
                    'text-success': cheque.status === 'CLEARED',
                    'text-danger': cheque.status === 'BOUNCED',
                    'text-warning text-dark': cheque.status === 'PENDING',
                    'text-info': cheque.status === 'DEPOSITED'
                  }" style="min-width:80px;">
                    {{ cheque.status }}
                  </span>
                  <select class="form-select form-select-sm border-primary" style="width:110px;" [ngModel]="cheque.status" (ngModelChange)="changeStatus(cheque, $event)">
                    <option value="PENDING">Pending</option>
                    <option value="CLEARED">Cleared</option>
                    <option value="BOUNCED">Bounced</option>
                    <option value="DEPOSITED">Deposited</option>
                  </select>
                </div>
              </td>
            </tr>
            <tr *ngIf="cheques.length === 0">
              <td colspan="8" class="text-center text-muted">No cheques found.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
